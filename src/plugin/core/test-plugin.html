<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lightweight Charts Line Tools Plugin - Smoke Test</title>
    <style>
        body { margin: 0; padding: 0; min-height: 100vh; display: flex; flex-direction: column; }
        #chart-container { flex-grow: 1; min-height: 400px; } /* Ensure container has height */
        #status-messages { padding: 10px; background-color: #f0f0f0; border-top: 1px solid #ccc; font-family: monospace; }
    </style>
</head>
<body>
    <div id="chart-container" style="width: 100%; height: 60vh;"></div>
    <div id="status-messages"></div>

    <!-- 
        1. Include the official Lightweight Charts library 
           Use the UMD version for simple <script> tag inclusion
           Adjust path if necessary 
    -->
    <script src="./node_modules/lightweight-charts/dist/lightweight-charts.standalone.development.js"></script>
    
    <!-- 
        2. Include your built core plugin
           Use the UMD version (lightweight-charts-line-tools-core.umd.js) for simple <script> tag inclusion
           Adjust path to your 'dist' folder and the correct UMD file
    -->
    <script src="./dist/lightweight-charts-line-tools-core.umd.js"></script>

    <script type="text/javascript">
        const statusDiv = document.getElementById('status-messages');
        let statusCounter = 1;

        function logStatus(message) {
            const p = document.createElement('p');
            p.textContent = `${statusCounter++}. ${message}`;
            statusDiv.appendChild(p);
            console.log(message);
        }

        try {
            logStatus('1. Creating Lightweight Charts instance...');
            const chartContainer = document.getElementById('chart-container');
            if (!chartContainer) {
                throw new Error('Chart container not found.');
            }
            const chart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.offsetWidth,
                height: chartContainer.offsetHeight,
                layout: {
                    background: { type: 'solid', color: '#1a202c' },
                    textColor: '#d1d4dc',
                },
                grid: {
                    vertLines: { color: '#2b2b43' },
                    horzLines: { color: '#2b2b43' },
                },
            });
            logStatus('   Lightweight Charts instance created successfully.');

            logStatus('2. Adding a dummy series to the chart...');
            const lineSeries = chart.addSeries(LightweightCharts.LineSeries,{ color: '#5487F2' }); 
            lineSeries.setData([
                { time: '2023-01-01', value: 100 },
                { time: '2023-01-02', value: 105 },
                { time: '2023-01-03', value: 102 },
                { time: '2023-01-04', value: 108 },
                { time: '2023-01-05', value: 103 },
            ]);
            logStatus('   Dummy series added.');

            logStatus('3. Attempting to initialize Line Tools Core Plugin...');
            // Check if LightweightChartsLineToolsCore (your UMD global name) is available
            if (typeof LightweightChartsLineToolsCore === 'undefined') {
                throw new Error('LightweightChartsLineTools (your plugin) is not defined. Check your build and script path.');
            }

            const lineToolsPlugin = LightweightChartsLineToolsCore.createLineToolsPlugin(chart, lineSeries);
            logStatus('   Line Tools Core Plugin initialized successfully.');

            logStatus('4. Verifying plugin API methods...');
            
            // List of all public methods from ILineToolsApi (public-api.ts)
            const expectedMethods = [
                'addLineTool',
                'createOrUpdateLineTool',
                'removeLineToolsById',
                'removeLineToolsByIdRegex',
                'removeSelectedLineTools',
                'removeAllLineTools',
                'getSelectedLineTools',
                'getLineToolByID',
                'getLineToolsByIdRegex',
                'applyLineToolOptions',
                'exportLineTools',
                'importLineTools',
                'subscribeLineToolsDoubleClick',
                'unsubscribeLineToolsDoubleClick',
                'subscribeLineToolsAfterEdit',
                'unsubscribeLineToolsAfterEdit',
                'setCrossHairXY',
                'clearCrossHair'
            ];

            const missingMethods = [];

            if (!lineToolsPlugin) {
                throw new Error('Plugin instance is null or undefined.');
            }

            expectedMethods.forEach(method => {
                if (typeof lineToolsPlugin[method] !== 'function') {
                    missingMethods.push(method);
                }
            });

            if (missingMethods.length === 0) {
                logStatus(`   All ${expectedMethods.length} API methods confirmed.`);
                logStatus('Smoke test passed! The core plugin is integrated and the API is fully exposed.');
                
                // Example of a valid call now that naming is fixed:
                // const id = lineToolsPlugin.addLineTool('TrendLine', [...]);
            } else {
                throw new Error(`API Verification Failed. Missing methods: ${missingMethods.join(', ')}`);
            }

        } catch (error) {
            logStatus(`ERROR: ${error.message}`);
            console.error(error);
        }
    </script>
</body>
</html>